<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>Dropbox 云同步密码管理器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>

<body>
    <h2>密码管理器（Dropbox 云同步）</h2>
    <p>账号ID: <input id="account" placeholder="如 myemail"></p>
    <p>密码: <input id="pwd" placeholder="要保存的密码"></p>
    <p>主密码: <input id="master" placeholder="用于加密/解密的主密码"></p>
    <button id="saveBtn">保存到 Dropbox</button>
    <button id="loadBtn">从 Dropbox 读取</button>

    <script>
        const APP_KEY = "hd4xukbxdczezo4";       // 必填
        const APP_SECRET = "qsjq9r4ilkvm0ag"; // 必填
        const REDIRECT_URI = "https://bejohnself.github.io/Tools/dropbox.html"; // 必须和Dropbox后台一致

        // AES 加密/解密
        function encrypt(text, masterPassword) {
            return CryptoJS.AES.encrypt(text, masterPassword).toString();
        }
        function decrypt(cipher, masterPassword) {
            try {
                const bytes = CryptoJS.AES.decrypt(cipher, masterPassword);
                return bytes.toString(CryptoJS.enc.Utf8);
            } catch {
                return null;
            }
        }

        // 获取 URL 参数
        function getQueryParam(name) {
            return new URLSearchParams(window.location.search).get(name);
        }

        // 用 refresh_token 获取新的 access_token
        async function getAccessToken() {
            const refreshToken = localStorage.getItem("dropbox_refresh_token");
            if (!refreshToken) return null;

            const res = await fetch("https://api.dropboxapi.com/oauth2/token", {
                method: "POST",
                headers: {
                    "Authorization": "Basic " + btoa(APP_KEY + ":" + APP_SECRET),
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({
                    refresh_token: refreshToken,
                    grant_type: "refresh_token"
                })
            });
            const data = await res.json();
            return data.access_token || null;
        }

        // 第一次授权获取 refresh_token
        async function exchangeCodeForTokens(code) {
            const res = await fetch("https://api.dropboxapi.com/oauth2/token", {
                method: "POST",
                headers: {
                    "Authorization": "Basic " + btoa(APP_KEY + ":" + APP_SECRET),
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({
                    code: code,
                    grant_type: "authorization_code",
                    redirect_uri: REDIRECT_URI
                })
            });
            const data = await res.json();
            if (data.refresh_token) {
                localStorage.setItem("dropbox_refresh_token", data.refresh_token);
                alert("授权成功！refresh_token 已保存");
                window.history.replaceState({}, document.title, REDIRECT_URI); // 清除URL参数
            } else {
                alert("授权失败：" + JSON.stringify(data));
            }
        }

        // 跳转到 Dropbox 授权页
        function startAuth() {
            const authUrl = `https://www.dropbox.com/oauth2/authorize?client_id=${APP_KEY}&response_type=code&token_access_type=offline&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
            window.location.href = authUrl;
        }

        // 上传文件到 Dropbox
        async function saveToDropbox(id, encrypted) {
            const accessToken = await getAccessToken();
            if (!accessToken) {
                alert("请先授权 Dropbox");
                startAuth();
                return;
            }

            const res = await fetch("https://content.dropboxapi.com/2/files/upload", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Dropbox-API-Arg": JSON.stringify({
                        path: `/passwords/${id}.json`,
                        mode: "overwrite",
                        mute: false
                    }),
                    "Content-Type": "application/octet-stream"
                },
                body: JSON.stringify({ value: encrypted })
            });

            if (res.ok) {
                alert("已加密并上传到 Dropbox");
            } else {
                alert("上传失败：" + await res.text());
            }
        }

        // 从 Dropbox 下载文件
        async function loadFromDropbox(id, masterPassword) {
            const accessToken = await getAccessToken();
            if (!accessToken) {
                alert("请先授权 Dropbox");
                startAuth();
                return;
            }

            const res = await fetch("https://content.dropboxapi.com/2/files/download", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Dropbox-API-Arg": JSON.stringify({ path: `/passwords/${id}.json` })
                }
            });

            if (res.ok) {
                const text = await res.text();
                const data = JSON.parse(text);
                const decrypted = decrypt(data.value, masterPassword);
                if (decrypted) {
                    alert("解密成功，密码是：" + decrypted);
                } else {
                    alert("解密失败，主密码错误或数据损坏");
                }
            } else {
                alert("读取失败：" + await res.text());
            }
        }

        // 绑定按钮事件
        document.getElementById("saveBtn").onclick = () => {
            const id = document.getElementById("account").value;
            const pwd = document.getElementById("pwd").value;
            const master = document.getElementById("master").value;
            if (id && pwd && master) {
                const encrypted = encrypt(pwd, master);
                saveToDropbox(id, encrypted);
            }
        };

        document.getElementById("loadBtn").onclick = () => {
            const id = document.getElementById("account").value;
            const master = document.getElementById("master").value;
            if (id && master) {
                loadFromDropbox(id, master);
            }
        };

        // 页面加载时检查是否带有授权码
        const code = getQueryParam("code");
        if (code) {
            exchangeCodeForTokens(code);
        }
    </script>
</body>

</html>