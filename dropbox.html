<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>安全版 Dropbox 云同步密码管理器（离线支持）</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>

<body>
    <h2>安全版密码管理器（Dropbox 云同步 + 离线缓存）</h2>
    <p>账号ID: <input id="account" placeholder="如 myemail"></p>
    <p>密码: <input id="pwd" placeholder="要保存的密码"></p>
    <p>主密码: <input id="master" placeholder="用于加密/解密的主密码"></p>
    <button id="saveBtn">保存</button>
    <button id="loadBtn">读取</button>

    <script>
        const APP_KEY = "hd4xukbxdczezo4";
        const APP_SECRET = "qsjq9r4ilkvm0ag";
        const REDIRECT_URI = "https://bejohnself.github.io/Tools/dropbox.html";

        // IndexedDB 初始化
        let db;
        const request = indexedDB.open("PasswordManagerDB", 1);
        request.onupgradeneeded = e => {
            db = e.target.result;
            if (!db.objectStoreNames.contains("passwords")) {
                db.createObjectStore("passwords", { keyPath: "id" });
            }
        };
        request.onsuccess = e => { db = e.target.result; };
        request.onerror = e => { console.error("IndexedDB 错误", e); };

        // 工具函数
        function generateSalt(len = 16) {
            return CryptoJS.lib.WordArray.random(len).toString();
        }
        function deriveKey(masterPassword, salt) {
            return CryptoJS.PBKDF2(masterPassword, CryptoJS.enc.Hex.parse(salt), {
                keySize: 256 / 32,
                iterations: 100000
            });
        }
        function encryptData(data, key) {
            return CryptoJS.AES.encrypt(JSON.stringify(data), key).toString();
        }
        function decryptData(cipher, key) {
            try {
                const bytes = CryptoJS.AES.decrypt(cipher, key);
                return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
            } catch { return null; }
        }
        function getQueryParam(name) {
            return new URLSearchParams(window.location.search).get(name);
        }

        // IndexedDB 操作
        function saveLocal(id, salt, cipher) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction("passwords", "readwrite");
                tx.objectStore("passwords").put({ id, salt, cipher, updatedAt: Date.now() });
                tx.oncomplete = () => resolve();
                tx.onerror = e => reject(e);
            });
        }
        function loadLocal(id) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction("passwords", "readonly");
                const req = tx.objectStore("passwords").get(id);
                req.onsuccess = () => resolve(req.result);
                req.onerror = e => reject(e);
            });
        }

        // Dropbox Token
        async function getAccessToken() {
            const refreshToken = localStorage.getItem("dropbox_refresh_token");
            if (!refreshToken) return null;
            const res = await fetch("https://api.dropboxapi.com/oauth2/token", {
                method: "POST",
                headers: {
                    "Authorization": "Basic " + btoa(APP_KEY + ":" + APP_SECRET),
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({
                    refresh_token: refreshToken,
                    grant_type: "refresh_token"
                })
            });
            const data = await res.json();
            return data.access_token || null;
        }
        async function exchangeCodeForTokens(code) {
            const res = await fetch("https://api.dropboxapi.com/oauth2/token", {
                method: "POST",
                headers: {
                    "Authorization": "Basic " + btoa(APP_KEY + ":" + APP_SECRET),
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({
                    code: code,
                    grant_type: "authorization_code",
                    redirect_uri: REDIRECT_URI
                })
            });
            const data = await res.json();
            if (data.refresh_token) {
                localStorage.setItem("dropbox_refresh_token", data.refresh_token);
                alert("授权成功！");
                window.history.replaceState({}, document.title, REDIRECT_URI);
            } else {
                alert("授权失败：" + JSON.stringify(data));
            }
        }
        function startAuth() {
            const authUrl = `https://www.dropbox.com/oauth2/authorize?client_id=${APP_KEY}&response_type=code&token_access_type=offline&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
            window.location.href = authUrl;
        }

        // Dropbox 同步
        async function saveToDropbox(id, salt, cipher) {
            const accessToken = await getAccessToken();
            if (!accessToken) { startAuth(); return; }
            const payload = { salt, cipher, updatedAt: Date.now() };
            await fetch("https://content.dropboxapi.com/2/files/upload", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Dropbox-API-Arg": JSON.stringify({
                        path: `/passwords/${id}.json`,
                        mode: "overwrite",
                        mute: false
                    }),
                    "Content-Type": "application/octet-stream"
                },
                body: JSON.stringify(payload)
            });
        }
        async function loadFromDropbox(id) {
            const accessToken = await getAccessToken();
            if (!accessToken) { startAuth(); return null; }
            const res = await fetch("https://content.dropboxapi.com/2/files/download", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Dropbox-API-Arg": JSON.stringify({ path: `/passwords/${id}.json` })
                }
            });
            if (res.ok) return JSON.parse(await res.text());
            return null;
        }

        // 保存按钮
        document.getElementById("saveBtn").onclick = async () => {
            const id = account.value.trim();
            const pwd = pwd.value.trim();
            const master = master.value.trim();
            if (!id || !pwd || !master) return alert("请填写完整信息");

            const salt = generateSalt();
            const key = deriveKey(master, salt);
            const cipher = encryptData({ value: pwd }, key);

            await saveLocal(id, salt, cipher);
            if (navigator.onLine) await saveToDropbox(id, salt, cipher);
            alert("已保存（本地 + 云端）");
        };

        // 读取按钮
        document.getElementById("loadBtn").onclick = async () => {
            const id = account.value.trim();
            const master = master.value.trim();
            if (!id || !master) return alert("请填写完整信息");

            let localData = await loadLocal(id);
            let cloudData = navigator.onLine ? await loadFromDropbox(id) : null;

            // 取最新版本
            let latest = localData;
            if (cloudData && (!localData || cloudData.updatedAt > localData.updatedAt)) {
                latest = cloudData;
                await saveLocal(id, cloudData.salt, cloudData.cipher);
            }

            if (!latest) return alert("没有找到数据");

            const key = deriveKey(master, latest.salt);
            const decrypted = decryptData(latest.cipher, key);
            if (decrypted) {
                alert("解密成功，密码是：" + decrypted.value);
            } else {
                alert("解密失败，主密码错误或数据损坏");
            }
        };

        // 页面加载时检查授权码
        const code = getQueryParam("code");
        if (code) exchangeCodeForTokens(code);
    </script>
</body>

</html>
